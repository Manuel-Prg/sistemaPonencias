---
import AdminLayout from "../../components/shared/AdminLayout.astro";
import "../../styles/pages/admin/targetAdmin.css";
---

<AdminLayout>
    <div class="admin-section">
        <div class="section-header">
            <h1 class="section-title">Asignar Moderadores a Salas</h1>
            <button class="admin-btn" id="refreshBtn">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path
                        d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                    ></path>
                </svg>
                Actualizar
            </button>
        </div>

        <div class="assignment-container">
            <!-- Columna de salas sin moderador -->
            <div class="column">
                <h2 class="column-title">Salas sin Moderador</h2>
                <div class="items-list" id="salasContainer">
                    <div class="loading">Cargando...</div>
                </div>
            </div>

            <!-- Columna de moderadores disponibles -->
            <div class="column">
                <h2 class="column-title">Moderadores Disponibles</h2>
                <div class="items-list" id="moderadoresContainer">
                    <div class="loading">Cargando...</div>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<!-- Modal para asignar moderador -->
<dialog id="assignModal" class="modal">
    <div class="modal-content">
        <h2>Asignar Moderador</h2>
        <div class="assignment-info">
            <p><strong>Sala:</strong> <span id="selectedSalaName"></span></p>
            <p>
                <strong>Moderador:</strong>
                <span id="selectedModeradorName"></span>
            </p>
        </div>
        <div class="modal-buttons">
            <button type="button" class="cancel-btn" id="cancelAssignBtn">
                Cancelar
            </button>
            <button type="button" class="submit-btn" id="confirmAssignBtn">
                Confirmar Asignación
            </button>
        </div>
    </div>
</dialog>

<script>
    import { SalaManagementService } from "../../lib/services/salas/salaManagement.service";
    import { showSuccess, showError } from "../../utils/notifications";
    import type { Sala } from "../../lib/models/sala";

    class ModeradorAssignmentManager {
        private service: SalaManagementService;
        private modal: HTMLDialogElement;
        private salasContainer: HTMLElement;
        private moderadoresContainer: HTMLElement;
        private selectedSala: (Sala & { id: string }) | null = null;
        private selectedModerador: any = null;

        constructor() {
            this.service = new SalaManagementService();
            this.modal = document.getElementById(
                "assignModal",
            ) as HTMLDialogElement;
            this.salasContainer = document.getElementById(
                "salasContainer",
            ) as HTMLElement;
            this.moderadoresContainer = document.getElementById(
                "moderadoresContainer",
            ) as HTMLElement;

            this.init();
        }

        private init() {
            this.setupEventListeners();
            this.loadData();
        }

        private setupEventListeners() {
            // Botón refrescar
            document
                .getElementById("refreshBtn")
                ?.addEventListener("click", () => {
                    this.loadData();
                });

            // Botones del modal
            document
                .getElementById("cancelAssignBtn")
                ?.addEventListener("click", () => {
                    this.closeModal();
                });

            document
                .getElementById("confirmAssignBtn")
                ?.addEventListener("click", async () => {
                    await this.handleAssignment();
                });

            // Cerrar modal al hacer clic fuera
            this.modal.addEventListener("click", (e) => {
                if (e.target === this.modal) {
                    this.closeModal();
                }
            });
        }

        private async loadData() {
            await Promise.all([this.loadSalas(), this.loadModerators()]);
        }

        private async loadSalas() {
            try {
                this.salasContainer.innerHTML =
                    '<div class="loading">Cargando...</div>';
                const salas = await this.service.getSalasWithoutModerator();

                if (salas.length === 0) {
                    this.salasContainer.innerHTML =
                        '<div class="empty-message">Todas las salas tienen moderador asignado</div>';
                    return;
                }

                this.salasContainer.innerHTML = "";
                salas.forEach((sala) => {
                    this.salasContainer.appendChild(this.createSalaItem(sala));
                });
            } catch (error) {
                showError("Error al cargar las salas");
                this.salasContainer.innerHTML =
                    '<div class="error-message">Error al cargar</div>';
            }
        }

        private async loadModerators() {
            try {
                this.moderadoresContainer.innerHTML =
                    '<div class="loading">Cargando...</div>';
                const moderadores = await this.service.getAvailableModerators();

                if (moderadores.length === 0) {
                    this.moderadoresContainer.innerHTML =
                        '<div class="empty-message">No hay moderadores disponibles</div>';
                    return;
                }

                this.moderadoresContainer.innerHTML = "";
                moderadores.forEach((moderador) => {
                    this.moderadoresContainer.appendChild(
                        this.createModeradorItem(moderador),
                    );
                });
            } catch (error) {
                showError("Error al cargar los moderadores");
                this.moderadoresContainer.innerHTML =
                    '<div class="error-message">Error al cargar</div>';
            }
        }

        private createSalaItem(sala: Sala & { id: string }): HTMLElement {
            const item = document.createElement("div");
            item.className = "assignment-item sala-item";
            item.dataset.id = sala.id;

            const ponenciasCount = sala.integrantes?.length || 0;

            item.innerHTML = `
        <div class="item-header">
          <h3>${sala.nombre || "Sin nombre"}</h3>
          <span class="badge">${ponenciasCount} ponencias</span>
        </div>
        <div class="item-info">
          <small>${sala.ubicacion || "Sin ubicación"}</small>
        </div>
        <button class="select-btn" data-type="sala">Seleccionar</button>
      `;

            item.querySelector(".select-btn")?.addEventListener("click", () => {
                this.selectSala(sala);
            });

            return item;
        }

        private createModeradorItem(moderador: any): HTMLElement {
            const item = document.createElement("div");
            item.className = "assignment-item moderador-item";
            item.dataset.id = moderador.id;

            const nombre = moderador.datos?.nombre || "Sin nombre";
            const email = moderador.email || "Sin email";

            item.innerHTML = `
        <div class="item-header">
          <h3>${nombre}</h3>
        </div>
        <div class="item-info">
          <small>${email}</small>
        </div>
        <button class="select-btn" data-type="moderador">Seleccionar</button>
      `;

            item.querySelector(".select-btn")?.addEventListener("click", () => {
                this.selectModerador(moderador);
            });

            return item;
        }

        private selectSala(sala: Sala & { id: string }) {
            // Remover selección previa
            document.querySelectorAll(".sala-item").forEach((item) => {
                item.classList.remove("selected");
            });

            // Seleccionar nueva sala
            const item = document.querySelector(
                `.sala-item[data-id="${sala.id}"]`,
            );
            item?.classList.add("selected");
            this.selectedSala = sala;

            // Si ya hay un moderador seleccionado, abrir modal
            if (this.selectedModerador) {
                this.openModal();
            }
        }

        private selectModerador(moderador: any) {
            // Remover selección previa
            document.querySelectorAll(".moderador-item").forEach((item) => {
                item.classList.remove("selected");
            });

            // Seleccionar nuevo moderador
            const item = document.querySelector(
                `.moderador-item[data-id="${moderador.id}"]`,
            );
            item?.classList.add("selected");
            this.selectedModerador = moderador;

            // Si ya hay una sala seleccionada, abrir modal
            if (this.selectedSala) {
                this.openModal();
            }
        }

        private openModal() {
            if (!this.selectedSala || !this.selectedModerador) return;

            const salaName = document.getElementById("selectedSalaName");
            const moderadorName = document.getElementById(
                "selectedModeradorName",
            );

            if (salaName && moderadorName) {
                salaName.textContent = this.selectedSala.nombre || "Sin nombre";
                moderadorName.textContent =
                    this.selectedModerador.datos?.nombre || "Sin nombre";
            }

            this.modal.showModal();
        }

        private closeModal() {
            this.modal.close();
        }

        private async handleAssignment() {
            if (!this.selectedSala || !this.selectedModerador) {
                showError("Debe seleccionar una sala y un moderador");
                return;
            }

            try {
                await this.service.assignModeradorToSala(
                    this.selectedSala.id,
                    this.selectedModerador.id,
                );

                showSuccess("Moderador asignado exitosamente");
                this.closeModal();

                // Limpiar selecciones
                this.selectedSala = null;
                this.selectedModerador = null;

                // Recargar datos
                await this.loadData();
            } catch (error) {
                showError("Error al asignar moderador");
            }
        }
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener("DOMContentLoaded", () => {
        new ModeradorAssignmentManager();
    });
</script>

<style>
    /* Container Grid */
    .assignment-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    /* Column Styles - Glassmorphism */
    .column {
        background: rgba(30, 30, 40, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        height: 100%;
        min-height: 500px;
    }

    .column-title {
        font-size: 1.25rem;
        margin: 0 0 1.5rem 0;
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Items List */
    .items-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
        scrollbar-width: thin;
        scrollbar-color: rgba(168, 85, 247, 0.5) transparent;
    }

    /* Assignment Item Card */
    .assignment-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .assignment-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border-color: rgba(168, 85, 247, 0.3);
    }

    .assignment-item.selected {
        background: linear-gradient(
            135deg,
            rgba(168, 85, 247, 0.15) 0%,
            rgba(216, 180, 254, 0.05) 100%
        );
        border: 1px solid rgba(168, 85, 247, 0.5);
        box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
    }

    /* Item Header */
    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .item-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: white;
        font-weight: 600;
    }

    /* Badge */
    .badge {
        background: rgba(168, 85, 247, 0.2);
        color: #d8b4fe;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid rgba(168, 85, 247, 0.3);
    }

    /* Item Info */
    .item-info {
        margin-bottom: 1rem;
    }

    .item-info small {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
        display: block;
    }

    /* Select Button */
    .select-btn {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }

    .assignment-item:hover .select-btn {
        background: rgba(168, 85, 247, 0.8);
        border-color: rgba(168, 85, 247, 0.8);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .assignment-item.selected .select-btn {
        background: #a855f7;
        border-color: #a855f7;
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
    }

    /* Modal Styling Fixes for this specific page */
    .assignment-info {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1.5rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .assignment-info p {
        margin: 0.75rem 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
    }

    .assignment-info span {
        color: #d8b4fe;
        font-weight: 600;
    }

    .loading,
    .empty-message,
    .error-message {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.6);
        font-style: italic;
    }

    .error-message {
        color: #fca5a5;
    }

    @media (max-width: 768px) {
        .assignment-container {
            grid-template-columns: 1fr;
        }
    }
</style>
